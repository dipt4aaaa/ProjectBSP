{% extends "base.html" %}

{% block content %}
<div class="content-header">
    <div class="row align-items-center">
        <div class="col">
            <h1 class="h3 mb-0">
                <i class="fas fa-tachometer-alt me-2"></i>
                Dashboard Overview
            </h1>
            <p class="text-muted mb-0">Ringkasan data absensi dan kehadiran karyawan</p>
        </div>
        <div class="col-auto">
            <button class="btn btn-primary" onclick="refreshDashboard()">
                <i class="fas fa-sync-alt me-1"></i>
                Refresh
            </button>
        </div>
    </div>
</div>

<!-- Stats Cards -->
<div class="row mb-4">
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card stats-card">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col">
                        <h5 class="card-title text-uppercase text-light mb-0">Total Karyawan</h5>
                        <span class="h2 font-weight-bold text-light" id="total-karyawan">-</span>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-users fa-2x text-light opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card stats-card info">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col">
                        <h5 class="card-title text-uppercase text-light mb-0">Hadir Hari Ini</h5>
                        <span class="h2 font-weight-bold text-light" id="kehadiran-hari-ini">-</span>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-user-check fa-2x text-light opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card stats-card warning">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col">
                        <h5 class="card-title text-uppercase text-light mb-0">Total Departemen</h5>
                        <span class="h2 font-weight-bold text-light" id="total-departemen">-</span>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-building fa-2x text-light opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card stats-card danger">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col">
                        <h5 class="card-title text-uppercase text-light mb-0">Absensi Bulan Ini</h5>
                        <span class="h2 font-weight-bold text-light" id="absensi-bulan-ini">-</span>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-calendar-check fa-2x text-light opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Charts Row -->
<div class="row">
    <!-- Kehadiran per Departemen -->
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-pie me-2"></i>
                    Kehadiran per Departemen (30 Hari Terakhir)
                </h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="departemenChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Trend Kehadiran Bulanan -->
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-line me-2"></i>
                    Trend Kehadiran Bulan Ini
                </h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="trendChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Recent Attendance -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <div class="row align-items-center">
                    <div class="col">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-clock me-2"></i>
                            Absensi Terbaru
                        </h5>
                    </div>
                    <div class="col-auto">
                        <a href="/log-absensi" class="btn btn-outline-primary btn-sm">
                            Lihat Semua
                        </a>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div id="recent-attendance-table"></div>
            </div>
        </div>
    </div>
</div>

<!-- Top Performers -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-trophy me-2"></i>
                    Top Performers (30 Hari Terakhir)
                </h5>
            </div>
            <div class="card-body">
                <div id="top-performers-table"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let departemenChart, trendChart;

    // Load dashboard data
    async function loadDashboardData() {
        try {
            // Load summary stats
            const summaryResponse = await fetch('/api/dashboard-summary');
            const summaryData = await summaryResponse.json();

            if (summaryData.success) {
                document.getElementById('total-karyawan').textContent = formatNumber(summaryData.data.total_karyawan);
                document.getElementById('kehadiran-hari-ini').textContent = formatNumber(summaryData.data.kehadiran_hari_ini);
                document.getElementById('total-departemen').textContent = formatNumber(summaryData.data.total_departemen);
                document.getElementById('absensi-bulan-ini').textContent = formatNumber(summaryData.data.absensi_bulan_ini);
            }

            // Load charts
            await loadDepartemenChart();
            await loadTrendChart();
            await loadRecentAttendance();
            await loadTopPerformers();

        } catch (error) {
            console.error('Error loading dashboard data:', error);
        }
    }

    // Load departemen chart
    async function loadDepartemenChart() {
        try {
            const response = await fetch('/api/statistik/departemen');
            const data = await response.json();

            if (data.success && data.data.length > 0) {
                const ctx = document.getElementById('departemenChart').getContext('2d');

                if (departemenChart) {
                    departemenChart.destroy();
                }

                departemenChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: data.data.map(d => d.departemen),
                        datasets: [{
                            data: data.data.map(d => d.total_kehadiran),
                            backgroundColor: [
                                '#3498db', '#e74c3c', '#2ecc71', '#f39c12',
                                '#9b59b6', '#1abc9c', '#34495e', '#e67e22'
                            ],
                            borderWidth: 2,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            }
        } catch (error) {
            console.error('Error loading departemen chart:', error);
        }
    }

    // Load trend chart
    async function loadTrendChart() {
        try {
            const response = await fetch('/api/statistik/kehadiran-bulanan');
            const data = await response.json();

            if (data.success && data.data.length > 0) {
                const ctx = document.getElementById('trendChart').getContext('2d');

                if (trendChart) {
                    trendChart.destroy();
                }

                trendChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.data.map(d => formatDate(d.tanggal)),
                        datasets: [{
                            label: 'Jumlah Kehadiran',
                            data: data.data.map(d => d.jumlah_hadir),
                            borderColor: '#3498db',
                            backgroundColor: 'rgba(52, 152, 219, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }
        } catch (error) {
            console.error('Error loading trend chart:', error);
        }
    }

    // Load recent attendance
    async function loadRecentAttendance() {
        try {
            const response = await fetch('/api/log-absensi?limit=10');
            const data = await response.json();

            if (data.success && data.data.length > 0) {
                let html = `
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Nama</th>
                                    <th>Departemen</th>
                                    <th>Posisi</th>
                                    <th>Tanggal</th>
                                    <th>Jam</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                data.data.slice(0, 10).forEach(log => {
                    html += `
                        <tr>
                            <td><strong>${log.nama}</strong></td>
                            <td><span class="badge bg-primary">${log.departemen || '-'}</span></td>
                            <td>${log.posisi || '-'}</td>
                            <td>${formatDate(log.tanggal)}</td>
                            <td>${formatTime(log.jam)}</td>
                        </tr>
                    `;
                });

                html += `
                            </tbody>
                        </table>
                    </div>
                `;

                document.getElementById('recent-attendance-table').innerHTML = html;
            } else {
                document.getElementById('recent-attendance-table').innerHTML = '<p class="text-muted text-center">Belum ada data absensi</p>';
            }
        } catch (error) {
            console.error('Error loading recent attendance:', error);
            showError('recent-attendance-table', 'Gagal memuat data absensi terbaru');
        }
    }

    // Load top performers
    async function loadTopPerformers() {
        try {
            const response = await fetch('/api/statistik/karyawan-ranking');
            const data = await response.json();

            if (data.success && data.data.length > 0) {
                let html = `
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Nama</th>
                                    <th>Departemen</th>
                                    <th>Posisi</th>
                                    <th>Total Kehadiran</th>
                                    <th>Hari Hadir</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                data.data.slice(0, 10).forEach((emp, index) => {
                    const rankIcon = index < 3 ? ['🥇', '🥈', '🥉'][index] : (index + 1);
                    html += `
                        <tr>
                            <td><strong>${rankIcon}</strong></td>
                            <td><strong>${emp.nama}</strong></td>
                            <td><span class="badge bg-info">${emp.departemen || '-'}</span></td>
                            <td>${emp.posisi || '-'}</td>
                            <td><span class="badge bg-success">${emp.total_kehadiran}</span></td>
                            <td>${emp.hari_hadir} hari</td>
                        </tr>
                    `;
                });

                html += `
                            </tbody>
                        </table>
                    </div>
                `;

                document.getElementById('top-performers-table').innerHTML = html;
            } else {
                document.getElementById('top-performers-table').innerHTML = '<p class="text-muted text-center">Belum ada data kehadiran</p>';
            }
        } catch (error) {
            console.error('Error loading top performers:', error);
            showError('top-performers-table', 'Gagal memuat data top performers');
        }
    }

    function refreshDashboard() {
        loadDashboardData();
    }

    // Initialize dashboard
    document.addEventListener('DOMContentLoaded', function () {
        loadDashboardData();

        // Auto refresh every 5 minutes
        setInterval(loadDashboardData, 300000);
    });
</script>
{% endblock %}